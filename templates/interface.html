{% extends "base.html" %}

{% block title %}Interface - Telescope Control{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interface - Telescope Control</title>
    <style>
        /* Basic page styles */
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            background-color: #f4f4f4;
        }

        /* Common panel styles */
        .draggable-panel {
            position: absolute;
            width: 300px;
            height: 500px; /* Increased height to accommodate new input */
            border: 1px solid #ccc;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            user-select: none;
            border-radius: 10px;
            background-color: white;
            padding: 10px;
        }

        /* Title bar where users will drag */
        .panel-header {
            color: white;
            padding: 10px;
            cursor: move;
            text-align: center;
            background-color: #FF5733;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
        }

        /* Content inside the panel */
        .panel-content {
            padding: 10px;
            height: calc(100% - 40px);
            overflow-y: auto;
        }

        /* Button styles */
        .panel-content button {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin: 5px;
        }

        /* Input box for step size */
        .step-input {
            padding: 5px;
            width: 80px;
            margin: 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
            text-align: center;
            cursor: pointer;
        }

        /* Row styles */
        .control-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .control-label {
            width: 150px;
            cursor: help;
        }

        .control-value {
            margin-right: 10px;
        }

        /* Static, immovable main panel in the center */
        #panel-main {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 75%;
            background-color: #333;
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 999;
            padding: 20px;
        }
    </style>
</head>
<body>

    <!-- Draggable Camera Controls Panel -->
    <div class="draggable-panel" id="panel-camera">
        <div class="panel-header" id="header-camera">
            <h4>Camera Controls</h4>
        </div>
        <div class="panel-content">
            <!-- Shutter Speed -->
            <div class="control-row" title="Controls the time the camera sensor is exposed to light (in seconds).">
                <span class="control-label">Shutter Speed</span>
                <button onclick="changeValue('shutterSpeed', -1)">-</button>
                <span class="control-value" id="shutterSpeedValue">1/1000</span>
                <button onclick="changeValue('shutterSpeed', 1)">+</button>
                <input type="number" class="step-input" id="shutterSpeedStep" value="1" onmouseover="this.select()" title="Shutter speed increment (e.g., change by 1/1000)">
            </div>

            <!-- ISO -->
            <div class="control-row" title="Controls the sensitivity of the camera's sensor to light. Higher values give brighter images but introduce noise.">
                <span class="control-label">ISO</span>
                <button onclick="changeValue('iso', -1)">-</button>
                <span class="control-value" id="isoValue">100</span>
                <button onclick="changeValue('iso', 1)">+</button>
                <input type="number" class="step-input" id="isoStep" value="100" onmouseover="this.select()" title="ISO increment (e.g., change by 100)">
            </div>

            <!-- Aperture -->
            <div class="control-row" title="Controls the size of the camera's aperture. Larger apertures let in more light.">
                <span class="control-label">Aperture</span>
                <button onclick="changeValue('aperture', -1)">-</button>
                <span class="control-value" id="apertureValue">2.8</span>
                <button onclick="changeValue('aperture', 1)">+</button>
                <input type="number" class="step-input" id="apertureStep" value="0.1" onmouseover="this.select()" title="Aperture increment (e.g., change by 0.1)">
            </div>

            <!-- White Balance -->
            <div class="control-row" title="Adjusts the color balance of the image based on light temperature (Kelvin).">
                <span class="control-label">White Balance</span>
                <button onclick="changeValue('whiteBalance', -1)">-</button>
                <span class="control-value" id="whiteBalanceValue">5000K</span>
                <button onclick="changeValue('whiteBalance', 1)">+</button>
                <input type="number" class="step-input" id="whiteBalanceStep" value="1000" onmouseover="this.select()" title="White balance increment (e.g., change by 1000K)">
            </div>

            <!-- Camera Focus -->
            <div class="control-row" title="Adjusts the focus of the camera lens.">
                <span class="control-label">Camera Focus</span>
                <button onclick="changeValue('focus', -1)">-</button>
                <span class="control-value" id="focusValue">10</span>
                <button onclick="changeValue('focus', 1)">+</button>
                <input type="number" class="step-input" id="focusStep" value="5" onmouseover="this.select()" title="Camera focus increment (e.g., change by 5)">
            </div>

            <!-- File Format -->
            <div class="control-row" title="Select the file format for saving images.">
                <span class="control-label">File Format</span>
                <select id="fileFormat" onchange="changeFileFormat()">
                    <option value="JPEG">JPEG</option>
                    <option value="PNG">PNG</option>
                    <option value="TIFF">TIFF</option>
                    <option value="RAW">RAW</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Static Main Panel (Centered) -->
    <div id="panel-main">
        <h4>Main Panel</h4>
        <p>This is the main panel. It stays in the center and cannot be moved. It spans about 80% of the screen width and 75% of the height, with equal space around it.</p>
    </div>

    <script>
        // Constants passed from Flask to JavaScript via Jinja templating
        window.ISO_MIN = {{ ISO_MIN }};
        window.ISO_MAX = {{ ISO_MAX }};
        window.SHUTTER_MIN = {{ SHUTTER_MIN }};
        window.SHUTTER_MAX = {{ SHUTTER_MAX }};
        window.APERTURE_MIN = {{ APERTURE_MIN }};
        window.APERTURE_MAX = {{ APERTURE_MAX }};
        window.WB_MIN = {{ WB_MIN }};
        window.WB_MAX = {{ WB_MAX }};
        window.FOCUS_MIN = {{ FOCUS_MIN }};
        window.FOCUS_MAX = {{ FOCUS_MAX }};

        // Initialize camera settings with default values
        let cameraSettings = {
            shutterSpeed: 1000, // 1/1000 sec
            iso: 100,
            aperture: 2.8,
            whiteBalance: 5000, // 5000K
            focus: 10,
            fileFormat: "JPEG" // Default file format
        };

        // Function to update the value for each camera setting
        function changeValue(setting, delta) {
            const step = parseFloat(document.getElementById(`${setting}Step`).value);

            // Ensure step is a positive number
            if (isNaN(step) || step <= 0) {
                alert("Please enter a valid step size.");
                return;
            }

            let newValue;

            if (setting === "shutterSpeed") {
                newValue = cameraSettings[setting] + (delta * step);
                newValue = Math.round(newValue * 1000) / 1000; // Rounded for shutter speed
            } else if (setting === "iso") {
                newValue = cameraSettings[setting] + (delta * step);
                newValue = Math.round(newValue); // ISO is an integer
            } else if (setting === "aperture") {
                newValue = cameraSettings[setting] + (delta * step);
                newValue = Math.round(newValue * 10) / 10; // Aperture rounded to one decimal
            } else if (setting === "whiteBalance") {
                newValue = cameraSettings[setting] + (delta * step);
                newValue = Math.round(newValue); // White Balance is an integer
            } else if (setting === "focus") {
                newValue = cameraSettings[setting] + (delta * step);
                newValue = Math.round(newValue); // Focus is rounded to an integer
            }

            // Enforce ranges for each setting
            if (setting === "iso" && (newValue < window.ISO_MIN || newValue > window.ISO_MAX)) {
                alert(`ISO value must be between ${window.ISO_MIN} and ${window.ISO_MAX}`);
                return;
            }
            if (setting === "shutterSpeed" && (newValue < window.SHUTTER_MIN || newValue > window.SHUTTER_MAX)) {
                alert(`Shutter Speed value must be between ${window.SHUTTER_MIN} and ${window.SHUTTER_MAX}`);
                return;
            }
            if (setting === "aperture" && (newValue < window.APERTURE_MIN || newValue > window.APERTURE_MAX)) {
                alert(`Aperture value must be between ${window.APERTURE_MIN} and ${window.APERTURE_MAX}`);
                return;
            }
            if (setting === "whiteBalance" && (newValue < window.WB_MIN || newValue > window.WB_MAX)) {
                alert(`White Balance value must be between ${window.WB_MIN} and ${window.WB_MAX}`);
                return;
            }
            if (setting === "focus" && (newValue < window.FOCUS_MIN || newValue > window.FOCUS_MAX)) {
                alert(`Focus value must be between ${window.FOCUS_MIN} and ${window.FOCUS_MAX}`);
                return;
            }

            // Update camera setting value and display
            cameraSettings[setting] = newValue;
            document.getElementById(`${setting}Value`).textContent = newValue;

            if (setting === "shutterSpeed") {
                document.getElementById(`${setting}Value`).textContent = `1/${Math.round(newValue)}`;
            }

            // Send the updated value to the Flask server via AJAX
            updateCameraSetting(setting, newValue);
        }

        // Function to send updated values to Flask backend via AJAX
        function updateCameraSetting(setting, newValue) {
            fetch("/update_camera_setting", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    setting: setting,
                    value: newValue,
                }),
            })
            .then(response => response.json())
            .then(data => {
                console.log(data.message);
            })
            .catch(error => console.error('Error:', error));
        }

        // Function to handle the file format change
        function changeFileFormat() {
            const selectedFormat = document.getElementById("fileFormat").value;
            cameraSettings.fileFormat = selectedFormat;

            // Send the updated file format to Flask backend via AJAX
            updateCameraSetting('fileFormat', selectedFormat);
        }

        // JavaScript for making the panels draggable
        function makeDraggable(panelId, headerId) {
            var panel = document.getElementById(panelId);
            var header = document.getElementById(headerId);
            var offsetX, offsetY;

            header.onmousedown = function(e) {
                offsetX = e.clientX - panel.offsetLeft;
                offsetY = e.clientY - panel.offsetTop;

                document.onmousemove = function(e) {
                    var left = e.clientX - offsetX;
                    var top = e.clientY - offsetY;
                    var maxLeft = window.innerWidth - panel.offsetWidth;
                    var maxTop = window.innerHeight - panel.offsetHeight;
                    left = Math.min(Math.max(left, 0), maxLeft);
                    top = Math.min(Math.max(top, 0), maxTop);
                    panel.style.left = left + 'px';
                    panel.style.top = top + 'px';
                };

                document.onmouseup = function() {
                    document.onmousemove = null;
                    document.onmouseup = null;
                };
            };
        }

        // Initialize draggable panels
        makeDraggable('panel-camera', 'header-camera');
    </script>

</body>
</html>
{% endblock %}